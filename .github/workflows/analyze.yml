name: Code Review Analyzer

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze:
    name: Run Code Review Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Build backend Docker image
        run: docker build -t ai-code-reviewer-backend ./backend

      - name: Get changed files
        id: changes
        uses: tj-actions/changed-files@v35

      - name: Run analysis on changed Python files
        run: |
          mkdir -p analysis
          echo "[" > analysis/results.json
          first=true

          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            if [[ "$file" == *.py ]]; then
              echo "Analyzing $file ..."

              OUTPUT=$(docker run \
                -v $GITHUB_WORKSPACE:/workspace \
                ai-code-reviewer-backend \
                "/workspace/$file")

              if [ "$first" = true ]; then
                echo "$OUTPUT" >> analysis/results.json
                first=false
              else
                echo ",$OUTPUT" >> analysis/results.json
              fi
            fi
          done

          echo "]" >> analysis/results.json

      - name: Post analysis comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: analysis/results.json
