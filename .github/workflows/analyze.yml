name: Code Review Analyzer

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze:
    name: Run Code Review Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Build backend Docker image
        run: |
          docker build -t ai-code-reviewer-backend ./backend

      - name: Get changed files
        id: changes
        uses: tj-actions/changed-files@v35

      - name: Run analysis on changed .py files
        run: |
          echo "[" > analysis_output.json
          first=true
          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            if [[ $file == *.py ]]; then
              echo "Analyzing $file"
              result=$(docker run ai-code-reviewer-backend \
                curl -s -X POST "http://localhost:8000/analyze" \
                -H "Content-Type: application/json" \
                -d "{\"file_path\": \"$file\"}")
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> analysis_output.json
              fi
              echo "$result" >> analysis_output.json
            fi
          done
          echo "]" >> analysis_output.json

      - name: Comment results on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: analysis_output.json
