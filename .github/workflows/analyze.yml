name: Code Review Analyzer

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Build backend Docker image
        run: |
          docker build -t ai-code-reviewer-backend ./backend

      - name: Start analyzer backend (FastAPI)
        run: |
          docker run -d --name analyzer -p 8000:8000 \
            -v $GITHUB_WORKSPACE:/app \
            ai-code-reviewer-backend
          sleep 5  # wait for FastAPI server to start

      - name: Get changed files
        id: changes
        uses: tj-actions/changed-files@v35

      - name: Initialize output file
        run: echo "[]" > analysis_output.json

      - name: Run analysis on changed files
        run: |
          echo "Changed files:"
          echo "${{ steps.changes.outputs.all_changed_files }}"

          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            if [[ "$file" == *.py ]]; then
              echo "Analyzing $file ..."

              RESULT=$(curl -s -X POST "http://localhost:8000/analyze" \
                -H "Content-Type: application/json" \
                -d "{\"file_path\": \"/app/$file\"}")

              echo "$RESULT"
              
              # Append analysis to JSON array
              jq ". + [$RESULT]" analysis_output.json > tmp.json && mv tmp.json analysis_output.json
            fi
          done

      - name: Stop analyzer container
        if: always()
        run: docker stop analyzer

      - name: Post summary comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: analysis_output.json
